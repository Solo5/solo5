#!/bin/bash

die()
{
    echo "$0: $@" 1>&2
    exit 1
}

if [ "$#" -lt 1 ]; then
    echo "Usage: ukvm-configure UKVM_SRC [MODULES]"
    echo "    UKVM_SRC is /path/to/ukvm"
    echo "    MODULES can be any combination of: net blk gdb"
    exit 1
fi


# Hopefully a more portable way to get absolute path...
UKVM_SRC=`(cd $(dirname $1)/$(basename $1) && pwd -P)`
# UKVM_SRC=`readlink -f $1`
if [ ! -d ${UKVM_SRC} -o ! -f ${UKVM_SRC}/core.c ]; then
    echo "Error: Not a ukvm source directory: ${UKVM_SRC}" 1>&2
    exit 1
fi
shift
UKVM_MODULES=$@

case $(uname -s) in
    Linux)
        MON="ukvm"
        MONFLAGS=
        ;;
    FreeBSD)
        MON="ukvm"
        MONFLAGS=
        ;;
    Darwin)
        MON="uhvf"
        MONFLAGS="-framework Hypervisor -framework vmnet"
        ;;
    *)
        die "Unsupported build OS: $(uname -s)"
        ;;
esac

cat <<EOF> Makefile.ukvm
# Generated by ukvm-configure $@

COMMON_MODULE_OBJS=\$(addsuffix .o,\$(addprefix _build-ukvm/,${UKVM_MODULES})) 
UKVM_MODULE_OBJS=\$(COMMON_MODULE_OBJS) \$(addsuffix .o,\$(addprefix _build-ukvm/${MON}-,${UKVM_MODULES}))

UKVM_MODULE_FLAGS=\$(addprefix -DUKVM_MODULE_,\$(shell echo ${UKVM_MODULES}| tr '[:lower:]' '[:upper:]'))

UKVM_CC?=cc
UKVM_FLAGS=-D__UKVM_HOST__ \$(UKVM_MODULE_FLAGS)
UKVM_CFLAGS=-Wall -Werror -std=c99 -O2 -g \$(UKVM_FLAGS)
UKVM_OBJS=_build-ukvm/core.o _build-ukvm/${MON}-core.o \$(UKVM_MODULE_OBJS)
ifdef UKVM_STATIC
UKVM_LDFLAGS=-static
endif
UKVM_HEADERS= \\
$UKVM_SRC/ukvm-private.h \\
$UKVM_SRC/ukvm-modules.h \\
$UKVM_SRC/ukvm-cpu.h \\
$UKVM_SRC/ukvm.h

_build-ukvm:
	mkdir -p _build-ukvm

_build-ukvm/$MON-%.o: $UKVM_SRC/$MON/$MON-%.c \$(MAKEFILE_LIST) | _build-ukvm
	\$(UKVM_CC) \$(UKVM_CFLAGS) -c \$< -o \$@

_build-ukvm/%.o: $UKVM_SRC/%.c \$(MAKEFILE_LIST) | _build-ukvm 
	\$(UKVM_CC) \$(UKVM_CFLAGS) -c \$< -o \$@

ukvm-bin: \$(UKVM_OBJS) \$(UKVM_HEADERS) \$(MAKEFILE_LIST)
	\$(UKVM_CC) \$(UKVM_LDFLAGS) -o \$@ \$(UKVM_CFLAGS) \$(UKVM_OBJS) $MONFLAGS

.PHONY: ukvm-clean
ukvm-clean:
	\$(RM) -r _build-ukvm
	\$(RM) ukvm-bin 

EOF

