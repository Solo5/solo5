#!/bin/sh
# Copyright (c) 2015-2018 Contributors as noted in the AUTHORS file
#
# This file is part of Solo5, a sandboxed execution environment.
#
# Permission to use, copy, modify, and/or distribute this software
# for any purpose with or without fee is hereby granted, provided
# that the above copyright notice and this permission notice appear
# in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
# WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
# AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR
# CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS
# OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
# NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
# CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

die ()
{
    echo "solo5-hvt-configure: error: $@" 1>&2
    exit 1
}

if [ "$#" -lt 1 ]; then
    cat <<EOM 1<&2
Usage: solo5-hvt-configure SOURCEDIR [ MODULES ... ]

Configures the solo5-hvt tender for your application, enabling the MODULES
specified.

Generates a Makefile.solo5-hvt in the current directory. Use the "solo5-hvt"
target to build the solo5-hvt tender binary.

Options:
    SOURCEDIR is the path to the solo5-hvt source
    MODULES can be any combination of: net blk gdb dumpcore

To use a cross-compiler, set the SOLO5_HVT_CC environment variable.
To build solo5-hvt statically, set the SOLO5_HVT_STATIC environment variable.
EOM
    exit 1
fi

SOLO5_HVT_CC=${SOLO5_HVT_CC:-cc}
SOLO5_HVT_SRC=$(readlink -f $1)
if [ ! -d ${SOLO5_HVT_SRC} -o ! -f ${SOLO5_HVT_SRC}/hvt_core.c ]; then
    die "Not a solo5-hvt source directory: ${SOLO5_HVT_SRC}"
fi
shift

add_cflags ()
{
    SOLO5_HVT_CFLAGS="${SOLO5_HVT_CFLAGS} $@"
}

add_obj ()
{
    for i in "$@"; do
        SOLO5_HVT_OBJS="${SOLO5_HVT_OBJS} _build-solo5-hvt/${i}"
    done
}

add_header ()
{
    for i in "$@"; do
    # XXX: This is a hack for Solo5 in-tree builds to avoid keeping two
    # copies or a symlink to hvt_abi.h around.
    if [ ! -f "${SOLO5_HVT_SRC}/${i}" -a -f \
            "${SOLO5_HVT_SRC}/../../include/solo5/${i}" ]; then
            SOLO5_HVT_HEADERS="${SOLO5_HVT_HEADERS} ${SOLO5_HVT_SRC}/../../include/solo5/${i}"
        add_cflags "-I${SOLO5_HVT_SRC}/../../include/solo5"
        add_cflags "-I${SOLO5_HVT_SRC}/../../bindings/muen"
    else
        SOLO5_HVT_HEADERS="${SOLO5_HVT_HEADERS} ${SOLO5_HVT_SRC}/${i}"
    fi
    done
}

add_module ()
{
    if [ ! -f ${SOLO5_HVT_SRC}/hvt_module_$1.c ]; then
        die "Invalid module: $1"
    fi
    if [ $1 = 'dumpcore' ]; then
        add_cflags "-DHVT_DROP_PRIVILEGES=0"
    fi
    enableit="-DHVT_MODULE_$(echo $1 | tr '[a-z]' '[A-Z]')"
    add_obj "hvt_module_$1.o"
    add_cflags "${enableit}"
}

SOLO5_HVT_CFLAGS=
SOLO5_HVT_LDFLAGS=
SOLO5_HVT_LDLIBS=
SOLO5_HVT_HEADERS=
SOLO5_HVT_OBJS=
add_obj hvt_core.o hvt_elf.o hvt_main.o
add_obj channel.o reader.o shm_net.o writer.o
add_header hvt.h hvt_abi.h cc.h

for module in "$@"; do
    [ -z "${module}" ] && continue
    if [ ${module} = "net" ]; then
    	SOLO5_HVT_LDLIBS="-lpthread"
    fi
    add_module ${module}
done

[ -n "${SOLO5_HVT_STATIC}" ] && SOLO5_HVT_LDFLAGS="-static"

TARGET=$(${SOLO5_HVT_CC} -dumpmachine)
[ $? -ne 0 ] &&
    die "Error running '${SOLO5_HVT_CC} -dumpmachine', is your compiler working?"
case ${TARGET} in
    x86_64-*linux*)
        add_obj hvt_kvm.o hvt_kvm_x86_64.o hvt_cpu_x86_64.o
        add_header hvt_kvm.h hvt_cpu_x86_64.h
        ;;
    x86_64-*freebsd1[12]*)
        add_obj hvt_freebsd.o hvt_freebsd_x86_64.o hvt_cpu_x86_64.o
        add_header hvt_freebsd.h hvt_cpu_x86_64.h
        ;;
    amd64-*-openbsd6.[4-9])
        add_obj hvt_openbsd.o hvt_openbsd_x86_64.o hvt_cpu_x86_64.o
        add_header hvt_openbsd.h hvt_cpu_x86_64.h
        ;;
    aarch64-*linux*)
        add_obj hvt_kvm.o hvt_kvm_aarch64.o hvt_cpu_aarch64.o
        add_header hvt_kvm.h hvt_cpu_aarch64.h
        ;;
    *)
        die "Unsupported compiler target: ${TARGET}"
        ;;
esac

cat <<EOF> Makefile.solo5-hvt
# Generated by 'solo5-hvt-configure $@'
# Using compiler '${SOLO5_HVT_CC}', target '${TARGET}'

.BEGIN: ; @echo -e Warning: \$(MAKEFILE) requires GNU make.\\\\nWarning: Attempting to build with \"gmake -f \$(MAKEFILE) \$(.TARGETS)\" for you now. && gmake -f \$(MAKEFILE) \$(.TARGETS)

.PHONY: all
all: solo5-hvt

SOLO5_HVT_CC=${SOLO5_HVT_CC}
SOLO5_HVT_CFLAGS=-Wall -Werror -std=c99 -O2 -g ${SOLO5_HVT_CFLAGS}
SOLO5_HVT_LDFLAGS=${SOLO5_HVT_LDFLAGS}
SOLO5_HVT_LDLIBS=${SOLO5_HVT_LDLIBS}

SOLO5_HVT_OBJS=${SOLO5_HVT_OBJS}
SOLO5_HVT_HEADERS=${SOLO5_HVT_HEADERS}

\$(SOLO5_HVT_OBJS): \$(SOLO5_HVT_HEADERS)

_build-solo5-hvt:
	mkdir -p _build-solo5-hvt

_build-solo5-hvt/%.o: ${SOLO5_HVT_SRC}/%.c \$(MAKEFILE_LIST) | _build-solo5-hvt
	\$(SOLO5_HVT_CC) \$(SOLO5_HVT_CFLAGS) -c \$< -o \$@

_build-solo5-hvt/channel.o: ${SOLO5_HVT_SRC}/../../bindings/muen/channel.c \$(MAKEFILE_LIST) | _build-solo5-hvt
	\$(SOLO5_HVT_CC) \$(SOLO5_HVT_CFLAGS) -c \$< -o \$@

_build-solo5-hvt/reader.o: ${SOLO5_HVT_SRC}/../../bindings/muen/reader.c \$(MAKEFILE_LIST) | _build-solo5-hvt
	\$(SOLO5_HVT_CC) \$(SOLO5_HVT_CFLAGS) -c \$< -o \$@

_build-solo5-hvt/shm_net.o: ${SOLO5_HVT_SRC}/../../bindings/muen/shm_net.c \$(MAKEFILE_LIST) | _build-solo5-hvt
	\$(SOLO5_HVT_CC) \$(SOLO5_HVT_CFLAGS) -c \$< -o \$@

_build-solo5-hvt/writer.o: ${SOLO5_HVT_SRC}/../../bindings/muen/writer.c \$(MAKEFILE_LIST) | _build-solo5-hvt
	\$(SOLO5_HVT_CC) \$(SOLO5_HVT_CFLAGS) -c \$< -o \$@

solo5-hvt: \$(SOLO5_HVT_OBJS) \$(MAKEFILE_LIST)
	\$(SOLO5_HVT_CC) \$(SOLO5_HVT_LDFLAGS) -o \$@ \$(SOLO5_HVT_OBJS) \$(SOLO5_HVT_LDLIBS)

.PHONY: solo5-hvt-clean
solo5-hvt-clean:
	rm -rf _build-solo5-hvt
	rm -f solo5-hvt
EOF
